(function () {
    "use strict";

    // =========================================================================
    // Auto-generated from JSON data. Do not edit manually.
    // =========================================================================

    // Auto-generated from JSON data. Do not edit manually.

    var SSB_DATA = [
        {word: "O", noteLength: 0.1875},
        {word: "say", noteLength: 0.25},
        {word: "can", noteLength: 0.25},
        {word: "you", noteLength: 0.25},
        {word: "see", noteLength: 0.5},
        {word: "by", noteLength: 0.125},
        {word: "the", noteLength: 0.0625},
        {word: "dawn\u2019s", noteLength: 0.25},
        {word: "early", noteLength: 0.5},
        {word: "light", noteLength: 0.5},
        {word: "What", noteLength: 0.125},
        {word: "so", noteLength: 0.125},
        {word: "proudly", noteLength: 0.375},
        {word: "we", noteLength: 0.25},
        {word: "hail\u2019d", noteLength: 0.5},
        {word: "at", noteLength: 0.125},
        {word: "the", noteLength: 0.125},
        {word: "twilight\u2019s", noteLength: 0.5},
        {word: "last", noteLength: 0.25},
        {word: "gleaming", noteLength: 0.5},
        {word: "Whose", noteLength: 0.125},
        {word: "broad", noteLength: 0.0625},
        {word: "stripes", noteLength: 0.25},
        {word: "and", noteLength: 0.25},
        {word: "bright", noteLength: 0.25},
        {word: "stars", noteLength: 0.5},
        {word: "through", noteLength: 0.125},
        {word: "the", noteLength: 0.0625},
        {word: "perilous", noteLength: 0.75},
        {word: "fight", noteLength: 0.5},
        {word: "O\u2019er", noteLength: 0.125},
        {word: "the", noteLength: 0.125},
        {word: "ramparts", noteLength: 0.375},
        {word: "we", noteLength: 0.25},
        {word: "watch\u2019d", noteLength: 0.5},
        {word: "were", noteLength: 0.125},
        {word: "so", noteLength: 0.125},
        {word: "gallantly", noteLength: 0.75},
        {word: "streaming", noteLength: 0.5},
        {word: "And", noteLength: 0.125},
        {word: "the", noteLength: 0.125},
        {word: "rocket\u2019s", noteLength: 0.5},
        {word: "red", noteLength: 0.25},
        {word: "glare", noteLength: 0.5},
        {word: "the", noteLength: 0.125},
        {word: "bombs", noteLength: 0.125},
        {word: "bursting", noteLength: 0.5},
        {word: "in", noteLength: 0.25},
        {word: "air", noteLength: 0.5},
        {word: "Gave", noteLength: 0.25},
        {word: "proof", noteLength: 0.25},
        {word: "through", noteLength: 0.125},
        {word: "the", noteLength: 0.25},
        {word: "night", noteLength: 0.5},
        {word: "that", noteLength: 0.125},
        {word: "our", noteLength: 0.125},
        {word: "flag", noteLength: 0.25},
        {word: "was", noteLength: 0.25},
        {word: "still", noteLength: 0.25},
        {word: "there", noteLength: 0.5},
        {word: "O", noteLength: 0.25},
        {word: "say", noteLength: 0.25},
        {word: "does", noteLength: 0.25},
        {word: "that", noteLength: 0.25},
        {word: "star-spangled", noteLength: 0.75},
        {word: "banner", noteLength: 0.5},
        {word: "yet", noteLength: 0.25},
        {word: "wave", noteLength: 0.5},
        {word: "O\u2019er", noteLength: 0.125},
        {word: "the", noteLength: 0.125},
        {word: "land", noteLength: 0.375},
        {word: "of", noteLength: 0.125},
        {word: "the", noteLength: 0.125},
        {word: "free", noteLength: 0.5},
        {word: "and", noteLength: 0.125},
        {word: "the", noteLength: 0.125},
        {word: "home", noteLength: 0.25},
        {word: "of", noteLength: 0.125},
        {word: "the", noteLength: 0.25},
        {word: "brave", noteLength: 0.5}
    ];

    var BREF_DATA = [
        {word: "Jos\u00e9 Canseco", noteLength: 1.4375},
        {word: "Byers", noteLength: 0.1875},
        {word: "Dawson", noteLength: 0.5},
        {word: "Lee", noteLength: 0.25},
        {word: "Light", noteLength: 0.5},
        {word: "Watson", noteLength: 0.25},
        {word: "Prough", noteLength: 0.21875},
        {word: "Dell", noteLength: 0.03125},
        {word: "Lee", noteLength: 0.375},
        {word: "Hale", noteLength: 0.5},
        {word: "Acta", noteLength: 0.25},
        {word: "Twining", noteLength: 0.5},
        {word: "Lasley", noteLength: 0.5},
        {word: "Mintz", noteLength: 0.25},
        {word: "Hu", noteLength: 0.125},
        {word: "Baird", noteLength: 0.0625},
        {word: "Strike", noteLength: 0.25},
        {word: "Cantz", noteLength: 0.25},
        {word: "Bright", noteLength: 0.25},
        {word: "Starr", noteLength: 0.5},
        {word: "Throop", noteLength: 0.125},
        {word: "Paul Powell", noteLength: 0.5625},
        {word: "Lis", noteLength: 0.25},
        {word: "Flythe", noteLength: 0.5},
        {word: "Odor", noteLength: 0.25},
        {word: "Rand", noteLength: 0.25},
        {word: "Partch", noteLength: 0.125},
        {word: "Weeks", noteLength: 0.25},
        {word: "Koch", noteLength: 0.5},
        {word: "Wordsworth", noteLength: 0.25},
        {word: "Gallen", noteLength: 0.5},
        {word: "Lee", noteLength: 0.25},
        {word: "Street", noteLength: 0.25},
        {word: "Mann", noteLength: 0.25},
        {word: "Anna", noteLength: 0.25},
        {word: "Rockett", noteLength: 0.5},
        {word: "Rettger", noteLength: 0.75},
        {word: "Dahl", noteLength: 0.125},
        {word: "Bonds", noteLength: 0.125},
        {word: "Bruske", noteLength: 0.25},
        {word: "King", noteLength: 0.25},
        {word: "Inge", noteLength: 0.25},
        {word: "Eyre", noteLength: 0.5},
        {word: "Babe Ruth", noteLength: 0.5},
        {word: "Toole", noteLength: 0.125},
        {word: "Lon Knight", noteLength: 0.75},
        {word: "Thatcher", noteLength: 0.25},
        {word: "Flager", noteLength: 0.5},
        {word: "Stillwell", noteLength: 0.75},
        {word: "Jos\u00e9 De La Torre", noteLength: 1.25},
        {word: "Spangler", noteLength: 0.5},
        {word: "Bannon", noteLength: 0.5},
        {word: "Yett", noteLength: 0.25},
        {word: "Cave", noteLength: 0.5},
        {word: "Orr", noteLength: 0.125},
        {word: "Dull", noteLength: 0.125},
        {word: "Land", noteLength: 0.375},
        {word: "Devers", noteLength: 0.25},
        {word: "Freese", noteLength: 0.5},
        {word: "Pat Mahomes", noteLength: 0.5},
        {word: "San\u00f3", noteLength: 0.375},
        {word: "Graves", noteLength: 0.5}
    ];

    var LINE_WORD_COUNTS = [10, 10, 10, 9, 10, 11, 8, 12];

    var BREF_LINKS = [
    "https://www.baseball-reference.com/players/c/cansejo01.shtml",
    "https://www.baseball-reference.com/players/b/byersra01.shtml",
    "https://www.baseball-reference.com/players/d/dawsoan01.shtml",
    "https://www.baseball-reference.com/players/l/leede02.shtml",
    "https://www.baseball-reference.com/players/l/lightpa01.shtml",
    "https://www.baseball-reference.com/players/w/watsoto01.shtml",
    "https://www.baseball-reference.com/players/p/prougbi01.shtml",
    "https://www.baseball-reference.com/players/d/dellwh01.shtml",
    "https://www.baseball-reference.com/players/l/leecl02.shtml",
    "https://www.baseball-reference.com/players/h/haleda02.shtml",
    "https://www.baseball-reference.com/managers/actama99.shtml",
    "https://www.baseball-reference.com/players/t/twinitw01.shtml",
    "https://www.baseball-reference.com/players/l/laslebi01.shtml",
    "https://www.baseball-reference.com/players/m/mintzst01.shtml",
    "https://www.baseball-reference.com/players/h/huch01.shtml",
    "https://www.baseball-reference.com/players/b/bairdbo01.shtml",
    "https://www.baseball-reference.com/players/s/strikjo01.shtml",
    "https://www.baseball-reference.com/players/c/cantzba01.shtml",
    "https://www.baseball-reference.com/players/b/brighha01.shtml",
    "https://www.baseball-reference.com/players/s/starrdi01.shtml",
    "https://www.baseball-reference.com/players/t/throoge01.shtml",
    "https://www.baseball-reference.com/players/p/powelpa01.shtml",
    "https://www.baseball-reference.com/players/l/lisjo01.shtml",
    "https://www.baseball-reference.com/players/f/flythst01.shtml",
    "https://www.baseball-reference.com/players/o/odorro01.shtml",
    "https://www.baseball-reference.com/players/r/randdi01.shtml",
    "https://www.baseball-reference.com/players/p/partccu01.shtml",
    "https://www.baseball-reference.com/players/w/weeksri01.shtml",
    "https://www.baseball-reference.com/players/k/kochbi01.shtml",
    "https://www.baseball-reference.com/players/w/wordsfa01.shtml",
    "https://www.baseball-reference.com/players/g/galleza01.shtml",
    "https://www.baseball-reference.com/players/l/leebr01.shtml",
    "https://www.baseball-reference.com/players/s/streehu01.shtml",
    "https://www.baseball-reference.com/players/m/mannbr01.shtml",
    "https://www.baseball-reference.com/players/a/annade01.shtml",
    "https://www.baseball-reference.com/players/r/rockepa01.shtml",
    "https://www.baseball-reference.com/players/r/rettgge01.shtml",
    "https://www.baseball-reference.com/players/d/dahlda01.shtml",
    "https://www.baseball-reference.com/players/b/bondsba01.shtml",
    "https://www.baseball-reference.com/players/b/bruskji01.shtml",
    "https://www.baseball-reference.com/players/k/kingcu01.shtml",
    "https://www.baseball-reference.com/players/i/ingebr01.shtml",
    "https://www.baseball-reference.com/players/e/eyrewi01.shtml",
    "https://www.baseball-reference.com/players/r/ruthba01.shtml",
    "https://www.baseball-reference.com/players/t/toolest01.shtml",
    "https://www.baseball-reference.com/managers/knighlo01.shtml",
    "https://www.baseball-reference.com/players/t/thatcjo01.shtml",
    "https://www.baseball-reference.com/players/f/flagewa01.shtml",
    "https://www.baseball-reference.com/players/s/stillku01.shtml",
    "https://www.baseball-reference.com/players/d/delatjo01.shtml",
    "https://www.baseball-reference.com/players/s/spangal01.shtml",
    "https://www.baseball-reference.com/players/b/bannoji01.shtml",
    "https://www.baseball-reference.com/players/y/yettri01.shtml",
    "https://www.baseball-reference.com/players/c/caveja01.shtml",
    "https://www.baseball-reference.com/players/o/orrpe01.shtml",
    "https://www.baseball-reference.com/players/d/dullry01.shtml",
    "https://www.baseball-reference.com/players/l/landdo01.shtml",
    "https://www.baseball-reference.com/players/d/deverra01.shtml",
    "https://www.baseball-reference.com/players/f/freesda01.shtml",
    "https://www.baseball-reference.com/players/m/mahompa01.shtml",
    "https://www.baseball-reference.com/players/s/sanomi01.shtml",
    "https://www.baseball-reference.com/players/g/graveda01.shtml"
];

    var BREF_LINE_BREAK_WORDS = ["Light", "Mintz", "Flythe", "Mann", "Eyre", "Stillwell", "Cave", "Graves"];

    // =========================================================================
    // Timing computation (port of anthem_utils.create_time_columns + web_app line builders)
    // =========================================================================

    function computeTiming(data, duration) {
        var notesSum = 0;
        var i;
        for (i = 0; i < data.length; i++) {
            notesSum += data[i].noteLength;
        }

        var cumTime = 0;
        var result = [];
        for (i = 0; i < data.length; i++) {
            var noteShare = data[i].noteLength / notesSum;
            var wordTime = noteShare * duration;
            var wordStartTime = cumTime;
            cumTime += wordTime;

            result.push({
                word: data[i].word,
                noteLength: data[i].noteLength,
                noteShare: noteShare,
                wordTime: wordTime,
                wordStartTime: wordStartTime,
                wordCumTime: cumTime
            });
        }

        return result;
    }

    function buildSsbLines(timedData) {
        var lines = [];
        var idx = 0;

        for (var li = 0; li < LINE_WORD_COUNTS.length; li++) {
            var count = LINE_WORD_COUNTS[li];
            var lineWords = [];

            for (var wi = 0; wi < count; wi++) {
                if (idx >= timedData.length) break;
                var row = timedData[idx];
                idx++;

                lineWords.push({
                    word: row.word,
                    startTime: Math.round(row.wordStartTime * 10000) / 10000,
                    endTime: Math.round(row.wordCumTime * 10000) / 10000,
                    duration: Math.round(row.wordTime * 10000) / 10000
                });
            }

            if (lineWords.length) {
                lines.push({words: lineWords});
            }
        }

        return lines;
    }

    function buildBrefLines(timedData) {
        var lines = [];
        var lineWords = [];

        for (var i = 0; i < timedData.length; i++) {
            var row = timedData[i];
            lineWords.push({
                word: row.word,
                startTime: Math.round(row.wordStartTime * 10000) / 10000,
                endTime: Math.round(row.wordCumTime * 10000) / 10000,
                duration: Math.round(row.wordTime * 10000) / 10000,
                link: i < BREF_LINKS.length ? BREF_LINKS[i] : null
            });

            if (BREF_LINE_BREAK_WORDS.indexOf(row.word) !== -1) {
                lines.push({words: lineWords});
                lineWords = [];
            }
        }

        if (lineWords.length) {
            lines.push({words: lineWords});
        }

        return lines;
    }

    function computeTimingData(duration, bref) {
        duration = Math.max(30, Math.min(200, duration));

        var data = bref ? BREF_DATA : SSB_DATA;
        var timedData = computeTiming(data, duration);
        var lines = bref ? buildBrefLines(timedData) : buildSsbLines(timedData);

        return {
            duration: duration,
            bref: bref,
            lines: lines
        };
    }

    // DOM elements
    const setupScreen = document.getElementById("setup-screen");
    const playerScreen = document.getElementById("player-screen");
    const durationSlider = document.getElementById("duration-slider");
    const durationInput = document.getElementById("duration-input");
    const brefToggle = document.getElementById("bref-toggle");
    const prepareBtn = document.getElementById("prepare-btn");
    const lyricsContainer = document.getElementById("lyrics-container");
    const progressBarContainer = document.getElementById("progress-bar-container");
    const progressBarFill = document.getElementById("progress-bar-fill");
    const progressBarHandle = document.getElementById("progress-bar-handle");
    const timeElapsed = document.getElementById("time-elapsed");
    const timeTotal = document.getElementById("time-total");
    const playPauseBtn = document.getElementById("play-pause-btn");
    const backBtn = document.getElementById("back-btn");
    const setupTitle = document.getElementById("setup-title");
    const playerTitle = document.getElementById("player-title");
    const playerHint = document.getElementById("player-hint");

    // State
    let timingData = null;
    let flatWords = [];
    let isPlaying = false;
    let startTimestamp = 0;
    let pauseOffset = 0;
    let currentWordIndex = -1;
    let animFrameId = null;
    let totalDuration = 0;
    const standardTitle = "Star Spangled Banner Tracker";
    const baseballReferenceTitle = "Star Spangler Bannon Tracker";
    const durationMin = parseFloat(durationSlider.min);
    const durationMax = parseFloat(durationSlider.max);

    // Format time like anthem_utils.seconds_to_minutes
    function formatTime(totalSeconds) {
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = (totalSeconds % 60).toFixed(1).padStart(4, "0");
        return minutes + ":" + seconds;
    }

    function getTrackerTitle() {
        return brefToggle.checked ? baseballReferenceTitle : standardTitle;
    }

    function updateTrackerTitle() {
        var trackerTitle = getTrackerTitle();
        setupTitle.textContent = trackerTitle;
        playerTitle.textContent = trackerTitle;
        document.title = trackerTitle;
    }

    function updatePlayerHint(showBrefHint) {
        if (!playerHint) return;
        if (showBrefHint) {
            playerHint.textContent = "Hint: Click a name to open their Baseball Reference page.";
            playerHint.hidden = false;
        } else {
            playerHint.textContent = "";
            playerHint.hidden = true;
        }
    }

    function setWordState(element, state) {
        var className = "word " + state;
        if (element.tagName === "A") {
            className += " word-link";
        }
        element.className = className;
    }

    function normalizeDuration(value) {
        var parsed = parseFloat(value);
        if (!isFinite(parsed)) {
            parsed = parseFloat(durationSlider.value);
        }
        if (!isFinite(parsed)) {
            parsed = durationMin;
        }

        var rounded = Math.round(parsed * 2) / 2;
        return Math.max(durationMin, Math.min(durationMax, rounded));
    }

    function syncDurationControls(value) {
        var normalized = normalizeDuration(value);
        var formatted = normalized.toFixed(1);
        durationSlider.value = formatted;
        durationInput.value = formatted;
        return normalized;
    }

    // Duration controls
    durationSlider.addEventListener("input", function () {
        syncDurationControls(this.value);
    });
    durationInput.addEventListener("input", function () {
        syncDurationControls(this.value);
    });
    durationInput.addEventListener("blur", function () {
        syncDurationControls(this.value);
    });

    syncDurationControls(durationSlider.value);
    brefToggle.addEventListener("change", updateTrackerTitle);
    updateTrackerTitle();

        // Prepare Track button
    prepareBtn.addEventListener("click", function () {
        const duration = syncDurationControls(durationInput.value);
        const bref = brefToggle.checked;

        const data = computeTimingData(duration, bref);
        timingData = data;
        totalDuration = data.duration;
        buildLyrics(data);
        showPlayer();
    });

    function buildLyrics(data) {
        lyricsContainer.innerHTML = "";
        flatWords = [];
        updatePlayerHint(Boolean(data.bref));

        var hasBrefLinks = Boolean(data.bref);

        data.lines.forEach(function (line) {
            var lineDiv = document.createElement("div");
            lineDiv.className = "lyric-line";

            line.words.forEach(function (w) {
                var wordEl;

                if (hasBrefLinks && w.link) {
                    wordEl = document.createElement("a");
                    wordEl.href = w.link;
                    wordEl.target = "_blank";
                    wordEl.rel = "noopener noreferrer";
                } else {
                    wordEl = document.createElement("span");
                }

                setWordState(wordEl, "upcoming");
                wordEl.textContent = w.word;
                lineDiv.appendChild(wordEl);
                lineDiv.appendChild(document.createTextNode(" "));

                flatWords.push({
                    startTime: w.startTime,
                    endTime: w.endTime,
                    element: wordEl,
                    lineElement: lineDiv,
                });
            });

            lyricsContainer.appendChild(lineDiv);
        });

        timeTotal.textContent = formatTime(totalDuration);
        timeElapsed.textContent = formatTime(0);
    }

    function showPlayer() {
        setupScreen.classList.remove("active");
        playerScreen.classList.add("active");
        document.body.classList.add("player-active");
        resetPlayback();
    }

    function showSetup() {
        stopPlayback();
        playerScreen.classList.remove("active");
        setupScreen.classList.add("active");
        document.body.classList.remove("player-active");
    }

    function resetPlayback() {
        stopPlayback();
        pauseOffset = 0;
        currentWordIndex = -1;
        isPlaying = false;
        playPauseBtn.textContent = "Play";
        updateProgressBar(0);
        timeElapsed.textContent = formatTime(0);

        // Reset all words to upcoming
        flatWords.forEach(function (fw) {
            setWordState(fw.element, "upcoming");
        });
        lyricsContainer.scrollTop = 0;
        updateLineHighlighting(-1);
    }

    function stopPlayback() {
        if (animFrameId !== null) {
            cancelAnimationFrame(animFrameId);
            animFrameId = null;
        }
        isPlaying = false;
    }

    // Play/Pause
    playPauseBtn.addEventListener("click", togglePlayPause);

    function togglePlayPause() {
        if (isPlaying) {
            pause();
        } else {
            play();
        }
    }

    function play() {
        if (pauseOffset >= totalDuration * 1000) {
            // Already finished, restart
            pauseOffset = 0;
            currentWordIndex = -1;
        }
        startTimestamp = performance.now() - pauseOffset;
        isPlaying = true;
        playPauseBtn.textContent = "Pause";
        tick();
    }

    function pause() {
        pauseOffset = performance.now() - startTimestamp;
        stopPlayback();
        playPauseBtn.textContent = "Play";
    }

    function tick() {
        if (!isPlaying) return;

        var now = performance.now();
        var elapsedMs = now - startTimestamp;
        var elapsed = Math.min(elapsedMs / 1000, totalDuration);

        // Find active word via binary search
        var activeIdx = findActiveWord(elapsed);

        if (activeIdx !== currentWordIndex) {
            updateWordStates(activeIdx);
            currentWordIndex = activeIdx;
        }

        updateProgressBar(elapsed / totalDuration);
        timeElapsed.textContent = formatTime(elapsed);

        if (elapsed >= totalDuration) {
            // Playback complete
            isPlaying = false;
            playPauseBtn.textContent = "Replay";
            pauseOffset = totalDuration * 1000;
            // Mark all words as sung
            flatWords.forEach(function (fw) {
                setWordState(fw.element, "sung");
            });
            updateLineHighlighting(-1);
            return;
        }

        animFrameId = requestAnimationFrame(tick);
    }

    // Binary search: find last word where startTime <= elapsed
    function findActiveWord(elapsed) {
        if (flatWords.length === 0) return -1;

        var lo = 0;
        var hi = flatWords.length - 1;
        var result = -1;

        while (lo <= hi) {
            var mid = (lo + hi) >>> 1;
            if (flatWords[mid].startTime <= elapsed) {
                result = mid;
                lo = mid + 1;
            } else {
                hi = mid - 1;
            }
        }

        return result;
    }

    function updateWordStates(activeIdx) {
        flatWords.forEach(function (fw, i) {
            if (i < activeIdx) {
                setWordState(fw.element, "sung");
            } else if (i === activeIdx) {
                setWordState(fw.element, "active");
            } else {
                setWordState(fw.element, "upcoming");
            }
        });

        if (activeIdx >= 0) {
            updateLineHighlighting(activeIdx);
        }
    }

    function updateLineHighlighting(activeIdx) {
        var activeLine = activeIdx >= 0 ? flatWords[activeIdx].lineElement : null;
        var allLines = lyricsContainer.querySelectorAll(".lyric-line");

        var activeLineIdx = -1;
        allLines.forEach(function (line, i) {
            line.classList.remove("active-line", "adjacent-line");
            if (line === activeLine) {
                activeLineIdx = i;
            }
        });

        if (activeLineIdx >= 0) {
            allLines[activeLineIdx].classList.add("active-line");
            if (activeLineIdx > 0) {
                allLines[activeLineIdx - 1].classList.add("adjacent-line");
            }
            if (activeLineIdx < allLines.length - 1) {
                allLines[activeLineIdx + 1].classList.add("adjacent-line");
            }
            scrollActiveLineIntoView(allLines[activeLineIdx]);
        }
    }

    function scrollActiveLineIntoView(activeLine) {
        if (!activeLine) return;
        if (!playerScreen.classList.contains("active")) return;
        if (!window.matchMedia("(max-width: 600px)").matches) return;
        if (lyricsContainer.clientHeight <= 0) return;

        var containerHeight = lyricsContainer.clientHeight;
        var currentScrollTop = lyricsContainer.scrollTop;
        var lineTop = activeLine.offsetTop;
        var lineBottom = lineTop + activeLine.offsetHeight;
        var topThreshold = currentScrollTop + containerHeight * 0.2;
        var bottomThreshold = currentScrollTop + containerHeight * 0.8;

        if (lineTop >= topThreshold && lineBottom <= bottomThreshold) {
            return;
        }

        var targetScrollTop = lineTop - (containerHeight - activeLine.offsetHeight) / 2;
        var maxScrollTop = Math.max(0, lyricsContainer.scrollHeight - containerHeight);
        targetScrollTop = Math.max(0, Math.min(maxScrollTop, targetScrollTop));

        if (Math.abs(targetScrollTop - currentScrollTop) < 2) {
            return;
        }

        lyricsContainer.scrollTo({
            top: targetScrollTop,
            behavior: isSeeking ? "auto" : "smooth",
        });
    }

    function updateProgressBar(fraction) {
        var pct = Math.max(0, Math.min(100, fraction * 100));
        progressBarFill.style.width = pct + "%";
        progressBarHandle.style.left = pct + "%";
    }

    // Seeking
    var isSeeking = false;

    function seekFromEvent(e) {
        var rect = progressBarContainer.getBoundingClientRect();
        var fraction = (e.clientX - rect.left) / rect.width;
        fraction = Math.max(0, Math.min(1, fraction));
        var seekTime = fraction * totalDuration;

        pauseOffset = seekTime * 1000;
        currentWordIndex = -1;

        if (isPlaying) {
            startTimestamp = performance.now() - pauseOffset;
        }

        // Force immediate state update
        var activeIdx = findActiveWord(seekTime);
        updateWordStates(activeIdx);
        currentWordIndex = activeIdx;
        updateProgressBar(fraction);
        timeElapsed.textContent = formatTime(seekTime);

        // Reset replay button if seeking before end
        if (seekTime < totalDuration && !isPlaying) {
            playPauseBtn.textContent = "Play";
        }
    }

    progressBarContainer.addEventListener("mousedown", function (e) {
        isSeeking = true;
        seekFromEvent(e);
    });

    document.addEventListener("mousemove", function (e) {
        if (isSeeking) {
            seekFromEvent(e);
        }
    });

    document.addEventListener("mouseup", function () {
        isSeeking = false;
    });

    // Touch support for progress bar
    progressBarContainer.addEventListener("touchstart", function (e) {
        isSeeking = true;
        seekFromEvent(e.touches[0]);
        e.preventDefault();
    });

    document.addEventListener("touchmove", function (e) {
        if (isSeeking) {
            seekFromEvent(e.touches[0]);
        }
    });

    document.addEventListener("touchend", function () {
        isSeeking = false;
    });

    // Back button
    backBtn.addEventListener("click", showSetup);

    // Keyboard shortcut: space for play/pause
    document.addEventListener("keydown", function (e) {
        if (e.code === "Space" && playerScreen.classList.contains("active")) {
            e.preventDefault();
            togglePlayPause();
        }
    });
})();

